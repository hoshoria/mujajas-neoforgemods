name: Add mods zip to Release

on:
  release:
    types: [created, published]   # se ejecuta cuando creas o publicas una Release

permissions:
  contents: write

jobs:
  upload-zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          lfs: true  # Esto descarga los archivos reales de Git LFS

      - name: Pull Git LFS files
        run: git lfs pull

      - name: Verify LFS files downloaded
        run: |
          echo "Verificando que los archivos .jar son reales (no punteros)..."
          # Verifica que al menos un archivo .jar tiene más de 1KB (los punteros son ~130 bytes)
          FIRST_JAR=$(find mods -name "*.jar" | head -1)
          if [ -f "$FIRST_JAR" ]; then
            SIZE=$(stat -c%s "$FIRST_JAR" 2>/dev/null || stat -f%z "$FIRST_JAR" 2>/dev/null)
            if [ "$SIZE" -lt 1000 ]; then
              echo "ERROR: Los archivos parecen ser punteros, no archivos reales"
              echo "Tamaño del archivo: $SIZE bytes (debería ser > 1000 bytes)"
              exit 1
            fi
            echo "✓ Archivo verificado: $FIRST_JAR ($SIZE bytes)"
            echo "✓ Total de archivos .jar encontrados: $(find mods -name '*.jar' | wc -l)"
          else
            echo "ERROR: No se encontraron archivos .jar en el directorio mods/"
            exit 1
          fi

      - name: Prepare variables
        id: meta
        run: |
          TAG="${{ github.event.release.tag_name }}"
          DATE=$(date -u +%Y%m%d)
          ZIP_NAME="mods-${DATE}-v${TAG}.zip"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "zip_name=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: Create zip
        run: |
          zip -r "${{ steps.meta.outputs.zip_name }}" mods
          ls -lh "${{ steps.meta.outputs.zip_name }}"

      - name: Upload zip to the existing Release
        run: |
          ZIP_FILE="${{ steps.meta.outputs.zip_name }}"
          UPLOAD_URL="${{ github.event.release.upload_url }}"
          
          # Sube el archivo zip a la release
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary "@${ZIP_FILE}" \
            "${UPLOAD_URL}?name=${ZIP_FILE}"

      - name: Print download URL
        run: |
          OWNER=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)
          REPO=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          TAG="${{ steps.meta.outputs.tag }}"
          ZIP="${{ steps.meta.outputs.zip_name }}"
          echo "Download URL:"
          echo "https://github.com/$OWNER/$REPO/releases/download/$TAG/$ZIP"
